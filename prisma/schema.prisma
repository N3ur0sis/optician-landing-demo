// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  WEBMASTER   // Content and site management (primary role)
  ADMIN       // Full system access
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  password     String
  name         String?
  role         Role     @default(WEBMASTER)
  isSuperAdmin Boolean  @default(false) // Protected admin created during deployment
  permissions  Json?    // Granular permissions for WEBMASTER users
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  sessions     Session[]

  @@index([email])
  @@index([role])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([provider, providerAccountId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// CMS Content Management Models
// ============================================

enum BlockType {
  // Text & Content
  HERO              // Hero section with title, subtitle, background
  TEXT              // Rich text content
  HEADING           // Standalone heading (H1-H6)
  PARAGRAPH         // Simple paragraph text
  QUOTE             // Blockquote with attribution
  LIST              // Bulleted or numbered list
  
  // Media
  IMAGE             // Single image with caption
  GALLERY           // Image gallery/carousel
  VIDEO             // Video embed or upload
  FILE              // Downloadable file
  
  // Layout
  COLUMNS           // Multi-column layout (2, 3, 4 cols)
  GRID              // Grid of cards/items
  SPACER            // Vertical spacing
  DIVIDER           // Horizontal divider line
  CONTAINER         // Wrapper with background/padding
  
  // Interactive
  BUTTON            // Call-to-action button
  LINK_BLOCK        // Link with preview
  ACCORDION         // Collapsible sections
  TABS              // Tabbed content
  
  // Data Display
  TABLE             // Data table
  STATS             // Statistics/numbers display
  TIMELINE          // Timeline of events
  CARDS             // Card grid layout
  
  // Embeds
  IFRAME            // External iframe embed
  MAP               // Google Maps embed
  SOCIAL            // Social media embed
  
  // Custom Components
  TEAM              // Team member cards
  TESTIMONIALS      // Customer testimonials
  PRICING           // Pricing tables
  FAQ               // FAQ accordion
  CONTACT_FORM      // Contact form
  NEWSLETTER        // Newsletter signup
  FEATURES          // Feature list with icons
  STORE_LIST        // Dynamic store list from database
  
  // Store-specific blocks
  STORE_HERO        // Store hero with name, address, description
  STORE_CONTACT     // Store contact info (address, phone, email, hours)
  STORE_SERVICES    // Store services grid
  STORE_CTA         // Store call-to-action buttons (RDV, Call)
  STORE_REVIEWS     // Store reviews/ratings display
  STORE_MAP         // Store location map
  STORE_LAYOUT      // Store page layout (2 columns: main content + sidebar)
}

enum OverlayType {
  LIGHT     // Light text on image
  DARK      // Dark text on image
}

enum TextAlign {
  LEFT
  CENTER
  RIGHT
  JUSTIFY
}

enum ContainerWidth {
  NARROW    // max-w-2xl
  MEDIUM    // max-w-4xl
  WIDE      // max-w-6xl
  FULL      // max-w-7xl
  EDGE      // No max-width
}

// Grid tiles for the main landing page ContentReveal component
model GridTile {
  id           String      @id @default(cuid())
  title        String
  caption      String?
  href         String
  backgroundUrl String     // Image URL or CSS gradient
  colSpan      Int         @default(2)  // 1-4 columns
  rowSpan      Int         @default(1)  // 1-2 rows
  colStart     Int         @default(1)  // Starting column 1-4
  rowStart     Int         @default(1)  // Starting row
  overlayType  OverlayType @default(DARK)
  overlayColor String?     // Custom overlay color (hex), e.g., "#0066cc"
  overlayOpacity Int       @default(60)  // Opacity 0-100
  order        Int         @default(0)  // Display order
  published    Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([published, order])
}

// Pages - dynamic content pages with slug-based routing
model Page {
  id              String    @id @default(cuid())
  slug            String    @unique  // URL path: /maison, /boutiques, etc.
  title           String
  metaTitle       String?   // SEO title
  metaDescription String?   // SEO description
  
  // Page Settings
  published       Boolean   @default(false)
  publishedAt     DateTime?
  template        String    @default("default") // default, landing, minimal, full-width
  
  // Page Styling
  backgroundColor String    @default("#ffffff")
  textColor       String    @default("#171717")
  customCSS       String?   // Custom CSS for page
  
  // Navbar Title (shows title instead of menu in center)
  showNavbarTitle  Boolean   @default(false) // Show title in navbar instead of menu
  navbarTitle      String?   // Custom title for navbar (defaults to page title)
  navbarSubtitle   String?   // Subtitle shown below title in navbar
  
  // Navigation (deprecated - use Navigation Manager instead)
  showInNav       Boolean   @default(true)
  navOrder        Int       @default(0)
  navLabel        String?   // Override title in nav
  parentSlug      String?   // For nested navigation
  
  // Soft Delete
  deletedAt       DateTime? // Null = active, set = soft deleted
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  blocks          PageBlock[]
  revisions       PageRevision[]

  @@index([slug])
  @@index([published])
  @@index([navOrder])
  @@index([deletedAt])
}

// Page Revisions - Version history for pages
model PageRevision {
  id              String   @id @default(cuid())
  pageId          String
  version         Int      // Auto-incrementing version number per page
  
  // Snapshot of page state
  title           String
  slug            String
  metaTitle       String?
  metaDescription String?
  template        String
  backgroundColor String
  textColor       String
  customCSS       String?
  published       Boolean
  showInNav       Boolean
  navOrder        Int
  navLabel        String?
  parentSlug      String?
  
  // Blocks snapshot as JSON
  blocksSnapshot  Json     // Full blocks array at this revision
  
  // Revision metadata
  createdAt       DateTime @default(now())
  createdBy       String?  // User ID who made the change
  changeNote      String?  // Optional description of changes
  
  // Relations
  page            Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([pageId, version])
  @@index([pageId, createdAt])
}

// Page Blocks - WordPress-style blocks with flexible JSON configuration
model PageBlock {
  id          String      @id @default(cuid())
  pageId      String
  type        BlockType
  order       Int         @default(0)
  
  // Block Content (flexible JSON based on type)
  content     Json        // Main content data
  
  // Block Styling
  settings    Json        @default("{}")  // Layout settings
  styles      Json        @default("{}")  // Custom styling (colors, spacing, etc.)
  
  // Block State
  visible     Boolean     @default(true)
  
  // Timestamps
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  // Relations
  page        Page        @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId, order])
  @@index([type])
}

// Sections - LEGACY: keeping for backward compatibility with existing code
model Section {
  id        String      @id @default(cuid())
  pageId    String
  type      String      @default("TEXT")
  order     Int         @default(0)
  config    Json        // Flexible JSON config per section type
  visible   Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@index([pageId, order])
}

// Navigation items - dynamic navbar configuration
model NavigationItem {
  id          String           @id @default(cuid())
  label       String           // Display text
  href        String?          // URL (null for parent-only items with dropdowns)
  
  // Hierarchical structure
  parentId    String?          // Null for top-level items
  order       Int              @default(0)
  depth       Int              @default(0)  // 0 = top level, 1 = submenu, 2 = nested submenu
  
  // Menu assignment
  menuId      String?          // Which menu this belongs to
  menu        NavigationMenu?  @relation(fields: [menuId], references: [id], onDelete: Cascade)
  
  // Page linkage (optional - for linking to CMS pages)
  pageSlug    String?          // Reference to Page.slug
  openInNewTab Boolean         @default(false)
  
  // Visual customization
  icon        String?          // Icon name (Lucide icon or custom)
  iconPosition String          @default("left") // left, right, none
  
  // Styling
  cssClass    String?          // Custom CSS classes
  style       Json             @default("{}") // Custom inline styles
  
  // Dropdown/submenu settings
  dropdownStyle String         @default("dropdown") // dropdown, mega, flyout
  parentClickable Boolean      @default(true) // Can click on parent to navigate (vs just open dropdown)
  
  // State
  published   Boolean          @default(true)
  highlighted Boolean          @default(false) // For special styling (e.g., CTA button)
  
  // Timestamps
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  // Self-referencing relations
  parent      NavigationItem?  @relation("NavigationHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    NavigationItem[] @relation("NavigationHierarchy")

  @@index([menuId, order])
  @@index([parentId, order])
  @@index([published])
  @@index([pageSlug])
}

// Navigation Menus - container for navigation items (header, footer, sidebar, etc.)
model NavigationMenu {
  id          String           @id @default(cuid())
  name        String           // Internal name: "Main Header", "Footer Links"
  slug        String           @unique // Unique identifier: "header", "footer", "sidebar"
  description String?          // Admin description
  
  // Menu Type & Position
  type        String           @default("header") // header, footer, sidebar, mobile
  position    String           @default("top")    // top, bottom, left, right
  
  // Layout & Style
  layout      String           @default("horizontal") // horizontal, vertical, grid
  alignment   String           @default("center")     // left, center, right, space-between
  
  // Display mode - how menu appears on desktop
  displayMode String           @default("hamburger-only") // hamburger-only, traditional, hybrid
  
  // Animation settings
  animation   String           @default("none")   // none, fade, slide, scale
  animationDuration Int        @default(200)      // milliseconds
  
  // Navbar styling
  navbarHeight    Int          @default(64)   // Navbar height in pixels
  fontSize        Int          @default(14)   // Font size in pixels for navbar items
  backgroundColor String?      // Menu background color
  textColor       String?      // Menu text color
  hoverColor      String?      // Hover state color
  activeColor     String?      // Active item color
  borderColor     String?      // Border color
  
  // Mobile menu styling
  mobileMenuBg    String?      @default("rgba(0,0,0,0.95)") // Mobile menu background
  mobileMenuText  String?      @default("#ffffff")         // Mobile menu text color
  mobileMenuHover String?      @default("#999999")         // Mobile menu hover color
  mobileMenuAccent String?     @default("#f59e0b")         // Mobile menu accent/highlight color
  mobileFontSize  Int          @default(18)                // Font size for mobile menu items
  
  // Spacing
  itemSpacing     Int          @default(24)  // Space between items (px)
  padding         String?      // CSS padding value
  
  // Scroll behavior
  shadowOnScroll  Boolean      @default(true)  // Show shadow when scrolled
  shrinkOnScroll  Boolean      @default(true)  // Reduce height when scrolled
  scrollOpacity   Int          @default(100)   // Opacity when scrolled (0-100%)
  hideOnScrollDown Boolean     @default(false) // Hide navbar on scroll down
  
  // Dropdown global settings
  dropdownAnimation String     @default("fadeDown") // fadeDown, slideDown, scale, none
  dropdownDelay   Int          @default(0)    // Delay before showing dropdown (ms)
  
  // Advanced styling
  customCSS       String?      // Custom CSS for this menu
  cssClasses      String?      // Additional CSS classes
  
  // Responsive
  mobileBreakpoint Int         @default(768)  // Pixel width for mobile behavior
  mobileStyle     String       @default("hamburger") // hamburger, slide, accordion
  
  // State
  published   Boolean          @default(true)
  
  // Timestamps
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  // Relations
  items       NavigationItem[]

  @@index([slug])
  @@index([type])
  @@index([published])
}

// Media library - uploaded images and videos
model Media {
  id          String   @id @default(cuid())
  filename    String   // Original filename
  path        String   // Storage path: /uploads/2025/12/filename.jpg
  url         String   // Public URL
  mimeType    String   // image/jpeg, video/mp4, etc.
  size        Int      // File size in bytes
  width       Int?     // Image/video width
  height      Int?     // Image/video height
  altText     String?  // SEO alt text
  caption     String?  // Optional caption
  uploadedAt  DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([mimeType])
  @@index([uploadedAt])
}

// Global site settings
model Settings {
  id        String   @id @default(cuid())
  key       String   @unique  // Setting identifier: site_title, logo_url, etc.
  value     Json     // Flexible JSON value
  updatedAt DateTime @updatedAt

  @@index([key])
}

// ============================================
// Analytics Models
// ============================================

// Individual page view tracking
model PageView {
  id          String   @id @default(cuid())
  path        String   // URL path: /maison, /magasins/reunion
  pageId      String?  // Reference to Page if it's a CMS page
  sessionId   String   // Anonymous session identifier
  userAgent   String?  // Browser/device info
  referrer    String?  // Traffic source
  country     String?  // Geo location (from IP)
  city        String?  // City (from IP)
  device      String?  // desktop, mobile, tablet
  browser     String?  // chrome, firefox, safari, etc.
  os          String?  // windows, macos, ios, android
  duration    Int?     // Time on page in seconds
  createdAt   DateTime @default(now())

  @@index([path])
  @@index([pageId])
  @@index([sessionId])
  @@index([createdAt])
  @@index([device])
}

// Daily aggregated statistics (for performance)
model DailyStats {
  id            String   @id @default(cuid())
  date          DateTime @db.Date // Day of stats
  path          String   // URL path
  pageId        String?  // Reference to Page if CMS page
  views         Int      @default(0) // Total page views
  uniqueVisitors Int     @default(0) // Unique sessions
  avgDuration   Float?   // Average time on page (seconds)
  bounceRate    Float?   // Percentage of single-page visits
  
  // Device breakdown
  desktopViews  Int      @default(0)
  mobileViews   Int      @default(0)
  tabletViews   Int      @default(0)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([date, path])
  @@index([date])
  @@index([path])
  @@index([pageId])
}

// Real-time active sessions
model ActiveSession {
  id          String   @id @default(cuid())
  sessionId   String   @unique
  path        String   // Current page
  startedAt   DateTime @default(now())
  lastSeenAt  DateTime @default(now())
  pageViews   Int      @default(1)
  
  @@index([lastSeenAt])
  @@index([path])
}
